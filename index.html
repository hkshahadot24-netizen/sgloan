<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶Æ‡ßá‡¶á‡¶® ‡¶ó‡ßá‡¶á‡¶ü ‡¶∏‡¶Æ‡¶¨‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶ø‡¶§‡¶ø</title>
  <!-- Tailwind CSS with Typography Plugin -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- Base Styles --- */
    body { 
        font-family: 'Noto Sans Bengali', 'Hind Siliguri', sans-serif; 
        background-color: #f8fafc; /* Slate 50 */
        padding-bottom: 60px;
    }
    
    /* --- Custom Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* --- Animations --- */
    @keyframes spin { 100% { transform: rotate(360deg);} }
    @keyframes spin-reverse { 100% { transform: rotate(-360deg); } }
    .animate-spin-slow { animation: spin 3s linear infinite; }
    .animate-spin-reverse { animation: spin-reverse 2s linear infinite; }
    
    @keyframes kenburns { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }
    .animate-kenburns { animation: kenburns 15s ease-in-out infinite alternate; }

    /* UPDATED: Seamless Marquee Animation */
    @keyframes marquee { 
        0% { transform: translateX(0); } 
        100% { transform: translateX(-100%); } 
    }
    .ticker-scroll-wrapper {
        display: flex;
        width: 100%;
        overflow: hidden;
    }
    .ticker-item {
        flex-shrink: 0;
        white-space: nowrap;
        padding-right: 50px; /* Gap between the end and start */
        animation: marquee 40s linear infinite; /* Smooth continuous speed */
    }
    .ticker-scroll-wrapper:hover .ticker-item {
        animation-play-state: paused;
    }

    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(20px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    /* --- Glassmorphism Header --- */
    .glass-header {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255,255,255,0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    /* --- Modern Card Hover Effects --- */
    .hover-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .hover-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }

    /* --- Lottery Modal Styles --- */
    #lottery-modal { font-family: 'Hind Siliguri', sans-serif; background-color: #0f172a; color: #f1f5f9; }
    .lottery-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
    
    /* --- Utility --- */
    .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; background-color: #eef2ff; }
  </style>
</head>
<body class="text-slate-800 antialiased">

  <!-- APP LOADER WITH DOUBLE RING & LOGO -->
  <div id="app-loader" class="fixed inset-0 z-[9999] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
      <div class="relative w-32 h-32 mb-6 flex justify-center items-center">
          <!-- Outer Ring Background -->
          <div class="absolute inset-0 border-[6px] border-indigo-50 rounded-full"></div>
          <!-- Outer Ring Spinner -->
          <div class="absolute inset-0 border-[6px] border-indigo-600 border-t-transparent border-b-transparent rounded-full animate-spin-slow"></div>
          
          <!-- Inner Ring Background -->
          <div class="absolute inset-4 border-[4px] border-pink-50 rounded-full"></div>
          <!-- Inner Ring Spinner (Reverse) -->
          <div class="absolute inset-4 border-[4px] border-pink-500 border-l-transparent border-r-transparent rounded-full animate-spin-reverse"></div>
          
          <!-- Center Logo -->
          <div class="absolute inset-0 m-auto w-14 h-14 rounded-full overflow-hidden border-2 border-white shadow-md z-10 bg-white flex justify-center items-center">
               <img id="loader-logo-img" src="https://placehold.co/64x64/FFFFFF/6366f1?text=MG" alt="Logo" class="w-full h-full object-cover p-1">
          </div>
      </div>
      <h2 class="text-lg font-bold text-slate-700 tracking-wider uppercase animate-pulse">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</h2>
  </div>

  <!-- Main Application Content -->
  <div id="main-app-content" class="hidden">
    
    <!-- Modern Header -->
    <header class="fixed top-0 w-full z-50 glass-header transition-all duration-300">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16 sm:h-20">
          
          <!-- Logo Area -->
          <div class="flex items-center gap-3">
            <div class="relative group cursor-pointer">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-pink-600 to-indigo-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-500"></div>
                <img id="header-logo-img" src="https://placehold.co/48x48/FFFFFF/6366f1?text=MG" alt="‡¶≤‡ßã‡¶ó‡ßã" class="relative w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-white object-cover bg-white shadow-sm">
            </div>
            <div class="flex flex-col">
              <h1 class="text-lg sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-700 to-pink-600 truncate leading-tight">
                ‡¶Æ‡ßá‡¶á‡¶® ‡¶ó‡ßá‡¶á‡¶ü ‡¶∏‡¶Æ‡¶¨‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶ø‡¶§‡¶ø
              </h1>
              <span class="text-[10px] sm:text-xs font-medium text-slate-500 tracking-wide">‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‚Ä¢ ‡¶è‡¶ï‡¶§‡¶æ ‚Ä¢ ‡¶∏‡¶Æ‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø</span>
            </div>
          </div>

          <!-- Smart Action Buttons -->
          <div class="flex items-center gap-3 sm:gap-4">
            
            <!-- Notification Bell -->
            <button id="open-notif-btn" class="relative group p-2 rounded-full hover:bg-slate-100 transition duration-200">
                <div class="text-2xl sm:text-2xl text-slate-600 group-hover:text-indigo-600 transition-colors">üîî</div>
                <span id="notif-badge" class="absolute top-1 right-1 bg-red-500 text-white text-[10px] font-bold h-4 w-4 sm:h-5 sm:w-5 flex items-center justify-center rounded-full border-2 border-white shadow-sm hidden transform scale-0 transition-transform duration-300"></span>
                <!-- Tooltip for PC -->
                <span class="absolute top-full mt-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-slate-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity hidden sm:block pointer-events-none whitespace-nowrap">‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</span>
            </button>

            <!-- App Button -->
            <a id="header-app-btn" href="#" class="relative overflow-hidden group bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-full px-4 py-1.5 sm:px-6 sm:py-2.5 shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                <span class="text-lg sm:text-xl">üì±</span> 
                <span class="text-xs sm:text-sm font-semibold hidden sm:inline">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</span>
                <span class="text-xs font-semibold sm:hidden">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</span>
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
            </a>

          </div>
        </div>
      </div>
    </header>

    <!-- Main Layout Grid -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-20 sm:pt-24 pb-8 space-y-6 sm:space-y-8">
      
      <!-- Top Section: Stats & Feature Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 fade-in-up" style="animation-delay: 0.1s;">
        <!-- Stat 1 -->
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-100 hover-card relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-50 rounded-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
            <p class="text-sm font-medium text-slate-500 relative z-10">‡¶Æ‡ßã‡¶ü ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø</p>
            <p id="total-members" class="text-2xl sm:text-4xl font-bold text-slate-800 mt-1 relative z-10">‡ß¶</p>
            <div class="mt-2 text-xs text-indigo-500 font-semibold flex items-center gap-1">üë• ‡¶è‡¶ï‡¶ü‡¶ø‡¶≠ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</div>
        </div>
        <!-- Stat 2 -->
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-100 hover-card relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-green-50 rounded-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
            <p class="text-sm font-medium text-slate-500 relative z-10">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</p>
            <p id="total-paid" class="text-xl sm:text-3xl font-bold text-green-600 mt-1 relative z-10 truncate">‡ß≥ ‡ß¶</p>
            <div class="mt-2 text-xs text-green-500 font-semibold">üí∞ ‡¶∏‡ßá‡¶≠‡¶ø‡¶Ç‡¶∏</div>
        </div>
        <!-- Stat 3 -->
        <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-100 hover-card relative overflow-hidden group">
            <div class="absolute right-0 top-0 w-24 h-24 bg-red-50 rounded-full -mr-8 -mt-8 opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
            <p class="text-sm font-medium text-slate-500 relative z-10">‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®</p>
            <p id="total-loan-given" class="text-xl sm:text-3xl font-bold text-red-500 mt-1 relative z-10 truncate">‡ß≥ ‡ß¶</p>
            <div class="mt-2 text-xs text-red-500 font-semibold">üìâ ‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó</div>
        </div>
        <!-- Monthly Fund Feature -->
        <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-4 sm:p-6 rounded-2xl shadow-lg hover-card text-white flex flex-col justify-between relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div>
                <h3 class="text-lg font-bold">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶§‡¶π‡¶¨‡¶ø‡¶≤</h3>
                <p class="text-xs text-indigo-100 opacity-90">‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶ì ‡¶¨‡¶ø‡¶§‡¶∞‡¶£</p>
            </div>
            <button id="view-monthly-fund-btn" class="mt-4 bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/40 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2">
                <span>‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</span> <span>‚ûú</span>
            </button>
        </div>
      </div>

      <!-- Middle Section: Notice & Charts (Grid Layout) -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8">
          
          <!-- Left Column (Notice & Lottery) - Span 4 on Desktop -->
          <div class="lg:col-span-4 space-y-6 fade-in-up" style="animation-delay: 0.2s;">
              
              <!-- Interactive Notice Board -->
              <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden group hover:shadow-md transition duration-300">
                   <div class="bg-slate-50 border-b border-slate-100 p-4 flex items-center justify-between">
                       <h3 class="font-bold text-slate-700 flex items-center gap-2">üì¢ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¨‡ßã‡¶∞‡ßç‡¶°</h3>
                       <span class="flex h-3 w-3 relative">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                       </span>
                   </div>
                   <div class="p-4">
                       <!-- Links hidden as per request -->
                       <div id="important-links-display" class="hidden mb-4"></div>
                       <div id="notice-display" class="text-slate-600 text-sm"></div>
                   </div>
              </div>

              <!-- Premium Lottery Card -->
              <div class="relative bg-slate-900 rounded-2xl p-1 overflow-hidden group hover:shadow-xl transition-all duration-500 transform hover:-translate-y-1">
                  <div class="absolute inset-0 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-500 opacity-75 group-hover:opacity-100 transition-opacity duration-500 animate-pulse"></div>
                  <div class="relative bg-slate-900 rounded-xl p-5 h-full flex flex-col items-center text-center">
                      <div class="text-4xl mb-2 group-hover:rotate-12 transition-transform duration-300">üé≤</div>
                      <h3 class="text-xl font-bold text-white mb-1">‡¶≤‡¶æ‡¶ï‡¶ø ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø</h3>
                      <p class="text-slate-400 text-xs mb-4">‡¶≠‡¶æ‡¶ó‡ßç‡¶Ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</p>
                      <button id="view-lottery-btn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold py-2 rounded-lg shadow-lg hover:shadow-cyan-500/50 transition-all duration-300 border border-white/10">
                          ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                      </button>
                  </div>
              </div>

          </div>

          <!-- Right Column (Charts) - Span 8 on Desktop -->
          <div class="lg:col-span-8 grid grid-cols-1 md:grid-cols-2 gap-6 fade-in-up" style="animation-delay: 0.3s;">
             <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[350px]">
                <h3 class="text-slate-700 font-bold mb-4 flex items-center gap-2"><span class="w-2 h-6 bg-green-500 rounded-full"></span>‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h3>
                <div class="flex-grow relative w-full">
                    <canvas id="financeChart"></canvas>
                </div>
             </div>
             <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[350px]">
                <h3 class="text-slate-700 font-bold mb-4 flex items-center gap-2"><span class="w-2 h-6 bg-indigo-500 rounded-full"></span>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ú‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞</h3>
                <div class="flex-grow relative w-full">
                    <canvas id="trendChart"></canvas>
                </div>
             </div>
          </div>

      </div>

      <!-- Member List Section -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden fade-in-up" style="animation-delay: 0.4s;">
        <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50/50">
           <div>
               <h3 class="text-2xl font-bold text-slate-800">‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶®‡¶ø‡¶§ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶¨‡ßÉ‡¶®‡ßç‡¶¶</h3>
               <p class="text-sm text-slate-500 mt-1">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</p>
           </div>
           <!-- Modern Search Bar -->
           <div class="relative w-full sm:w-80">
               <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">üîç</span>
               <input id="search-member-input" type="search" placeholder="‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent shadow-sm text-sm transition-all" autocomplete="off">
           </div>
        </div>
        
        <!-- Grid of Members -->
        <div class="p-6">
            <div id="member-list-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="member-list-placeholder" class="hidden py-12 flex flex-col items-center justify-center text-slate-400">
                <span class="text-4xl mb-2">üïµÔ∏è‚Äç‚ôÇÔ∏è</span>
                <p>‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>
            </div>
        </div>
      </div>

    </main>

    <!-- AUTO TOAST CONTAINER (UPDATED: Top centered on mobile, Bottom right on desktop) -->
    <div id="auto-toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 sm:top-auto sm:bottom-10 sm:left-auto sm:right-4 sm:translate-x-0 z-[200] flex flex-col gap-2 items-center sm:items-end pointer-events-none w-full max-w-[90%] sm:max-w-sm px-0 sm:px-4"></div>

    <!-- FIXED BOTTOM TICKER (Modernized) -->
    <div id="bottom-ticker" class="fixed bottom-0 left-0 w-full bg-slate-900 text-white z-40 border-t-2 border-indigo-500 hidden shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
        <div class="flex items-center h-10 sm:h-12 overflow-hidden relative">
            <div class="bg-indigo-600 text-white px-4 h-full flex items-center font-bold z-10 shadow-lg whitespace-nowrap text-xs sm:text-sm tracking-wide">
                üì¢ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü:
            </div>
            <!-- UPDATED: Ticker container structure for seamless loop -->
            <div class="w-full overflow-hidden relative h-full flex items-center bg-slate-800/50 backdrop-blur-sm">
                <div id="ticker-wrapper" class="ticker-scroll-wrapper">
                     <!-- JS will inject duplicated items here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-status" class="fixed bottom-20 left-4 bg-slate-800/90 backdrop-blur text-white py-1.5 px-3 rounded-full shadow-xl transition-opacity duration-300 opacity-0 z-50 flex items-center gap-2 text-xs border border-slate-600">
          <div id="sync-spinner" class="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
          <span id="sync-text">‡¶∏‡¶ø‡¶ô‡ßç‡¶ï...</span>
    </div>
    
    <!-- Message Box -->
    <div id="message-box" class="fixed top-20 sm:top-24 left-1/2 -translate-x-1/2 z-[300] transition-opacity duration-300 opacity-0 w-[90%] max-w-md">
        <div id="message-content" class="shadow-2xl rounded-xl p-4 font-semibold text-white flex items-center gap-3 backdrop-blur-md"></div>
    </div>
  </div>
  
  <!-- Hidden Modals (Auth & Verify) -->
  <div id="verify-email-modal" class="hidden fixed inset-0 bg-slate-50 z-[150] justify-center items-center p-4"></div>
  <div id="auth-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[200] justify-center items-center p-4 backdrop-blur-sm"></div>

  <!-- Notification Modal (Side Panel) -->
  <div id="notif-modal" class="hidden fixed inset-0 z-[80] justify-end overflow-hidden">
    <div id="notif-overlay-bg" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity duration-300 opacity-0"></div>
    <div id="notif-panel" class="relative bg-white w-full max-w-sm h-full shadow-2xl flex flex-col transform translate-x-full transition-transform duration-300 ease-out z-10">
        <div class="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white flex justify-between items-center shadow-md shrink-0">
            <h3 class="text-lg font-bold flex items-center gap-2">üîî ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® <span id="notif-count" class="bg-white/20 text-xs px-2 py-0.5 rounded-full border border-white/30">0</span></h3>
            <div class="flex items-center gap-1">
                <button id="mark-read-btn" title="‡¶∏‡¶¨ ‡¶™‡¶†‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" class="p-2 rounded-full hover:bg-white/20 transition text-white/90">‚úì‚úì</button>
                <button id="close-notif-btn" class="p-2 rounded-full hover:bg-white/20 transition text-xl leading-none">&times;</button>
            </div>
        </div>
        <div id="notif-list" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50 scroll-smooth">
            <div class="flex flex-col items-center justify-center h-full text-slate-400 gap-2"><span class="text-4xl">üîï</span><span>‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶®‡ßá‡¶á</span></div>
        </div>
        <div class="sm:hidden w-full py-3 flex justify-center items-center text-slate-400 bg-white border-t text-xs">‚ü∏ ‡¶∏‡ßã‡ßü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</div>
    </div>
  </div>

  <!-- Profile Modal (Modernized) -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 justify-center items-center p-0 sm:p-4">
    <div id="profile-modal-box" class="bg-white sm:rounded-2xl shadow-2xl w-full max-w-6xl h-full sm:h-[90vh] flex flex-col relative overflow-hidden modal-exit">
      
      <!-- Modal Header -->
      <div class="relative bg-slate-800 text-white p-6 sm:p-8 flex flex-col items-center justify-center shrink-0 overflow-hidden">
           <div class="absolute inset-0 bg-gradient-to-br from-indigo-600 to-purple-700 opacity-90"></div>
           <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
           <button id="close-profile" class="absolute top-4 right-4 text-white/60 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-2 transition z-20">&times;</button>
           
           <div class="relative z-10 flex flex-col items-center">
               <div class="relative">
                   <img id="profile-header-img" src="" class="w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border-4 border-white/20 shadow-xl mb-3 bg-slate-200">
                   <div class="absolute bottom-4 right-0 w-6 h-6 bg-green-500 border-4 border-slate-800 rounded-full"></div>
               </div>
               <h2 id="profile-header-name" class="text-2xl sm:text-3xl font-bold text-white tracking-wide">‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</h2>
               <span id="profile-id" class="text-indigo-200 text-sm font-mono mt-1 bg-white/10 px-2 py-0.5 rounded">ID: ---</span>
           </div>
      </div>

      <!-- Navigation Tabs -->
      <div class="flex border-b border-slate-200 bg-slate-50 shrink-0 overflow-x-auto">
          <button id="profile-tab-details" class="profile-tab tab-active flex-1 min-w-[120px] py-4 text-sm font-semibold hover:bg-white transition text-center">üë§ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
          <button id="profile-tab-transactions" class="profile-tab text-slate-500 flex-1 min-w-[120px] py-4 text-sm font-semibold hover:bg-white transition text-center">üßæ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</button>
          <button id="profile-tab-summary" class="profile-tab text-slate-500 flex-1 min-w-[120px] py-4 text-sm font-semibold hover:bg-white transition text-center">üìà ‡¶∏‡¶æ‡¶∞-‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</button>
      </div>

      <!-- Content Area -->
      <div id="profile-content-container" class="overflow-y-auto flex-grow bg-slate-50 p-4 sm:p-8">
          <!-- Details -->
          <div id="profile-content-details" class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-sm border border-slate-100">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="space-y-4">
                      <div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase font-bold mb-1">‡¶®‡¶æ‡¶Æ</p><p id="profile-name-view" class="text-slate-800 font-medium"></p></div>
                      <div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase font-bold mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</p><p id="profile-email-view" class="text-slate-800 font-medium break-all"></p></div>
                      <div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase font-bold mb-1">‡¶´‡ßã‡¶®</p><p id="profile-phone-view" class="text-slate-800 font-medium"></p></div>
                  </div>
                  <div class="space-y-4">
                      <div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase font-bold mb-1">‡¶è‡¶Æ‡¶™‡ßç‡¶≤‡¶Ø‡¶º‡¶ø ‡¶Ü‡¶á‡¶°‡¶ø</p><p id="profile-employee-id-view" class="text-slate-800 font-medium"></p></div>
                      <div class="p-3 bg-slate-50 rounded-lg"><p class="text-xs text-slate-500 uppercase font-bold mb-1">‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</p><p id="profile-card-number-view" class="text-slate-800 font-medium"></p></div>
                  </div>
                  <div class="md:col-span-2">
                       <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-100"><p class="text-xs text-yellow-700 uppercase font-bold mb-2">‡¶®‡ßã‡¶ü / ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø</p><p id="profile-notes-view" class="text-slate-700 text-sm whitespace-pre-wrap leading-relaxed"></p></div>
                  </div>
              </div>
          </div>
          
          <!-- Transactions -->
          <div id="profile-content-transactions" class="hidden h-full">
              <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
                  <div class="overflow-y-auto flex-grow">
                      <table class="min-w-full text-left text-sm">
                          <thead class="bg-slate-100 text-slate-600 sticky top-0 z-10 shadow-sm"><tr><th class="py-3 px-4 font-semibold">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th class="py-3 px-4 font-semibold">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th class="py-3 px-4 text-right font-semibold">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</th></tr></thead>
                          <tbody id="transactions-table-body" class="divide-y divide-slate-100"></tbody>
                      </table>
                  </div>
              </div>
          </div>
          
          <!-- Summary -->
          <div id="profile-content-summary" class="hidden max-w-4xl mx-auto">
               <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                   <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 flex flex-col items-center justify-center">
                       <div class="text-green-100 bg-green-500 p-3 rounded-full mb-3 text-2xl">üí∞</div>
                       <p class="text-slate-500 text-sm">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</p>
                       <p id="paid-total" class="text-3xl font-bold text-slate-800 mt-1">‡ß≥ ‡ß¶</p>
                   </div>
                   <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500 flex flex-col items-center justify-center">
                       <div class="text-red-100 bg-red-500 p-3 rounded-full mb-3 text-2xl">üìâ</div>
                       <p class="text-slate-500 text-sm">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ã‡¶£</p>
                       <p id="current-loan" class="text-3xl font-bold text-slate-800 mt-1">‡ß≥ ‡ß¶</p>
                   </div>
                   <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500 flex flex-col items-center justify-center">
                       <p class="text-slate-500 text-sm">‡¶Æ‡ßã‡¶ü ‡¶ã‡¶£ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</p>
                       <p id="loan-taken" class="text-xl font-bold text-blue-600 mt-1">‡ß≥ ‡ß¶</p>
                   </div>
                   <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500 flex flex-col items-center justify-center">
                       <p class="text-slate-500 text-sm">‡¶Æ‡ßã‡¶ü ‡¶ã‡¶£ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</p>
                       <p id="loan-repaid" class="text-xl font-bold text-yellow-600 mt-1">‡ß≥ ‡ß¶</p>
                   </div>
               </div>
          </div>
      </div> 
    </div>
  </div>

  <!-- Monthly Fund Modal -->
  <div id="monthly-fund-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 justify-center items-center p-4">
    <div id="monthly-fund-modal-box" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-0 relative overflow-hidden flex flex-col max-h-[80vh]">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 flex justify-between items-center text-white shrink-0">
          <h3 class="text-xl font-bold">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶§‡¶π‡¶¨‡¶ø‡¶≤</h3>
          <button id="close-fund-modal" class="hover:bg-white/20 rounded-full p-1 transition text-2xl leading-none">&times;</button>
      </div>
      <div id="fund-list-container" class="p-4 space-y-3 overflow-y-auto bg-slate-50 flex-grow"></div>
    </div>
  </div>

  <!-- Lottery Modal (Full Screen Immersive) -->
  <div id="lottery-modal" class="hidden fixed inset-0 z-[100] flex flex-col bg-[#0f172a] text-slate-200">
    <canvas id="confetti" class="fixed inset-0 pointer-events-none z-0"></canvas>
    
    <!-- Lottery Header -->
    <div class="relative z-10 flex justify-between items-center p-4 lg:px-8 border-b border-slate-800 bg-[#0f172a]/80 backdrop-blur">
        <button id="close-lottery-btn" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition border border-slate-700">
            <span>‚¨Ö ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</span>
        </button>
        <div class="text-right">
            <h1 class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">‡¶≤‡¶æ‡¶ï‡¶ø ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø</h1>
        </div>
    </div>
    
    <!-- Lottery Content -->
    <div class="relative z-10 w-full max-w-[1600px] mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 grow overflow-y-auto">
        <!-- Sidebar: History -->
        <div class="lg:col-span-3 flex flex-col gap-4 order-2 lg:order-1">
            <div class="lottery-card p-4 rounded-xl flex-1 flex flex-col">
                <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-700 pb-2">üìú ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶¨‡¶ø‡¶ú‡ßü‡ßÄ</h2>
                <ul id="lotteryHistory" class="space-y-2 overflow-y-auto flex-1 max-h-[300px] lg:max-h-none text-sm pr-1 custom-scrollbar"></ul>
            </div>
        </div>

        <!-- Main: Winner & Participants -->
        <div class="lg:col-span-9 flex flex-col gap-6 order-1 lg:order-2">
            <!-- Winner Showcase -->
            <div id="lotteryWinnerSection" class="hidden w-full transition-all duration-700 transform scale-95 opacity-0">
                <div class="lottery-card p-8 md:p-12 rounded-2xl border border-yellow-500/30 shadow-[0_0_50px_rgba(234,179,8,0.2)] text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-yellow-500/10 to-transparent"></div>
                    <h3 class="text-2xl md:text-3xl text-yellow-400 mb-4 font-bold animate-pulse relative z-10">üéâ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ú‡ßü‡ßÄ üéâ</h3>
                    <div id="lotteryWinnerText" class="text-5xl md:text-7xl font-extrabold text-white break-words drop-shadow-xl tracking-wide relative z-10"></div>
                    <div id="lotteryWinnerDate" class="text-slate-400 mt-4 font-mono text-sm relative z-10"></div>
                </div>
            </div>

            <!-- Participants Grid -->
            <div class="lottery-card p-6 rounded-xl flex-1 flex flex-col shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-slate-200">‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ</h2>
                    <span class="bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-full text-xs font-bold border border-cyan-500/20">‡¶Æ‡ßã‡¶ü: <span id="lotteryCountBadge">0</span></span>
                </div>
                <ul id="lotteryParticipants" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-6 gap-3 overflow-y-auto max-h-[500px] pr-2">
                    <li class="col-span-full text-center text-slate-600 italic py-10">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</li>
                </ul>
            </div>
        </div>
    </div>
  </div>


  <!-- JAVASCRIPT LOGIC (Unchanged but connected to new UI) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Config
    const appId = 'default-samiti-app-id'; 
    const firebaseConfig = { apiKey: "AIzaSyBdfxO5LL9KfzJe-PhvaRbhDhz9G-QH1aE", authDomain: "sg-loan-online.firebaseapp.com", projectId: "sg-loan-online", storageBucket: "sg-loan-online.firebasestorage.app", messagingSenderId: "933667418231", appId: "1:933667418231:web:11c24150426bf869381672" };

    let app, db, auth;
    let members = [], fundDistribution = {}, notice = { text: '', imageUrls: [], linkText: '', linkUrl: '', scrollingText: '' }, logoUrl = '', importantLinks = [], lottery = { participants: [], history: [], liveDraw: null };
    let activityLog = []; 
    let appDownloadUrl = ''; 
    let activeMember = null, searchQuery = '';
    
    let noticeSlideInterval = null;
    let financeChartInstance = null;
    let trendChartInstance = null;
    let lastDrawTime = 0;
    let isFirstSnapshot = true;
    let initialLoadComplete = false;
    
    // DOM Elements
    const mainAppContent = document.getElementById('main-app-content');
    const memberListCardContainer = document.getElementById('member-list-cards');
    const memberListPlaceholder = document.getElementById('member-list-placeholder');
    const profileModal = document.getElementById('profile-modal');
    const monthlyFundModal = document.getElementById('monthly-fund-modal'); 

    // Utils
    const getBengaliNumber = (n) => {
        if (n === null || n === undefined || isNaN(n)) return "‡ß¶";
        return new Intl.NumberFormat('bn-BD', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n);
    };
    const formatDate = (dateString, format = 'long') => {
        if (!dateString) return '';
        const date = new Date(dateString);
        if (format === 'long') return `${new Intl.NumberFormat('bn-BD').format(date.getDate())} ${date.toLocaleString('bn-BD', { month: 'long' })}, ${new Intl.NumberFormat('bn-BD').format(date.getFullYear())}`;
        if (format === 'monthYear') return date.toLocaleString('bn-BD', { month: 'long', year: 'numeric'});
        return '';
    };
    const showMessage = (msg, type = 'success') => {
      const box = document.getElementById('message-box');
      const content = document.getElementById('message-content');
      let color = type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-600' : 'bg-green-600';
      content.className = `shadow-2xl rounded-xl p-4 font-semibold text-white flex items-center gap-3 backdrop-blur-md ${color}`;
      content.innerHTML = `<span>${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span><span>${msg}</span>`;
      box.classList.remove('opacity-0'); setTimeout(() => box.classList.add('opacity-0'), 3000);
    };
    const calculateMemberTotals = (m) => {
        const t = { totalDeposit: 0, totalLoanTaken: 0, totalLoanRepaid: 0, currentLoan: 0 };
        if(m?.transactions) m.transactions.forEach(x => { const a = Number(x.amount)||0; if(x.type === 'deposit') t.totalDeposit+=a; else if(x.type === 'loanTaken') t.totalLoanTaken+=a; else if(x.type === 'loanRepayment') t.totalLoanRepaid+=a; });
        t.currentLoan = t.totalLoanTaken - t.totalLoanRepaid; return t;
    };

    // Notifications
    const openNotif = () => {
        const m = document.getElementById('notif-modal'), p = document.getElementById('notif-panel'), o = document.getElementById('notif-overlay-bg');
        m.classList.remove('hidden'); m.classList.add('flex');
        setTimeout(() => { p.classList.remove('translate-x-full'); o.classList.remove('opacity-0'); }, 10);
    };
    const closeNotif = () => {
        const m = document.getElementById('notif-modal'), p = document.getElementById('notif-panel'), o = document.getElementById('notif-overlay-bg');
        p.classList.add('translate-x-full'); o.classList.add('opacity-0');
        setTimeout(() => { m.classList.add('hidden'); m.classList.remove('flex'); }, 300);
    };
    const renderNotifications = () => {
        const list = document.getElementById('notif-list'), badge = document.getElementById('notif-badge'), count = document.getElementById('notif-count');
        const lastRead = Number(localStorage.getItem('samiti_notif_last_read') || 0);
        const unread = activityLog.filter(l => l.ts > lastRead).length;
        
        if (unread > 0) { badge.textContent = getBengaliNumber(unread); badge.classList.remove('hidden'); badge.classList.add('animate-bounce'); } 
        else { badge.classList.add('hidden'); badge.classList.remove('animate-bounce'); }
        count.textContent = getBengaliNumber(activityLog.length);
        list.innerHTML = '';

        if (activityLog.length === 0) { list.innerHTML = '<div class="flex flex-col items-center justify-center h-48 text-slate-400 gap-2"><span class="text-4xl">üîï</span><span>‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶®‡ßá‡¶á</span></div>'; return; }
        
        activityLog.forEach(log => {
            let icon = 'üìå', border = 'border-l-4 border-slate-300';
            if(log.msg.includes('‡¶ú‡¶Æ‡¶æ') || log.msg.includes('‡¶ü‡¶æ‡¶ï‡¶æ')) { icon = 'üí∞'; border = 'border-l-4 border-green-500'; }
            else if(log.msg.includes('‡¶ã‡¶£')) { icon = 'üí∏'; border = 'border-l-4 border-red-500'; }
            else if(log.msg.includes('‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø')) { icon = 'üé≤'; border = 'border-l-4 border-purple-500'; }
            
            const isUnread = log.ts > lastRead;
            const bg = isUnread ? 'bg-indigo-50/50' : 'bg-white';
            const memberMatch = members.find(m => log.msg.includes(m.name));
            const actionAttr = memberMatch ? `data-member-id="${memberMatch.id}"` : '';
            const actionBtn = memberMatch ? `<span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full ml-auto">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‚ûú</span>` : '';

            list.innerHTML += `<div data-notification-msg="${log.msg}" ${actionAttr} class="${bg} p-3 rounded-lg shadow-sm ${border} mb-2 cursor-pointer hover:bg-slate-50 transition relative"><div class="flex justify-between items-start"><span class="text-sm text-slate-700 font-medium flex gap-2">${icon} <span class="flex-1">${log.msg}</span></span>${isUnread?'<span class="w-2 h-2 rounded-full bg-red-500 mt-1.5 shrink-0"></span>':''}</div><div class="flex items-center mt-2 text-xs text-slate-400"><span>${log.dateStr}</span>${actionBtn}</div></div>`;
        });
    };
    
    // Auto Toast
    const checkAndPlayNotifications = () => {
        const lastRead = Number(localStorage.getItem('samiti_notif_last_read') || 0);
        const unreadLogs = activityLog.filter(l => l.ts > lastRead).sort((a,b) => a.ts - b.ts);
        if (unreadLogs.length > 0) playNotificationSequence(unreadLogs);
    };
    const playNotificationSequence = (logs) => {
        if (logs.length === 0) return;
        const current = logs[0]; showAutoToast(current);
        localStorage.setItem('samiti_notif_last_read', current.ts); renderNotifications();
        setTimeout(() => playNotificationSequence(logs.slice(1)), 3000);
    };
    
    // UPDATED: Show Auto Toast with Mobile-Optimized Design
    const showAutoToast = (log) => {
        const c = document.getElementById('auto-toast-container'), t = document.createElement('div');
        let icon = 'üìå', border = 'border-l-4 border-slate-300';
        if(log.msg.includes('‡¶ú‡¶Æ‡¶æ')) { icon = 'üí∞'; border = 'border-l-4 border-green-500'; }
        else if(log.msg.includes('‡¶ã‡¶£')) { icon = 'üí∏'; border = 'border-l-4 border-red-500'; }
        
        const memberMatch = members.find(m => log.msg.includes(m.name));
        
        // Mobile: Compact, Top-aligned (slight slide down). Desktop: Normal, Bottom-aligned (slide up).
        t.className = `bg-white/95 backdrop-blur-sm p-3 sm:p-4 rounded-lg sm:rounded-xl shadow-lg sm:shadow-2xl ${border} w-full flex items-center gap-3 transform -translate-y-4 sm:translate-y-10 opacity-0 transition-all duration-500 cursor-pointer pointer-events-auto border border-slate-100`;
        t.setAttribute('data-notification-msg', log.msg);
        if (memberMatch) t.setAttribute('data-member-id', memberMatch.id);

        t.innerHTML = `<div class="text-xl sm:text-2xl">${icon}</div><div class="flex-1 min-w-0"><p class="font-bold text-slate-800 text-xs sm:text-sm truncate">${log.msg}</p><p class="text-[10px] text-slate-400 mt-0.5">‡¶è‡¶ñ‡¶®‡¶á</p></div>`;
        
        c.appendChild(t);
        
        // Trigger enter animation
        requestAnimationFrame(() => { t.classList.remove('-translate-y-4', 'translate-y-10', 'opacity-0'); });
        
        // Trigger exit animation
        setTimeout(() => { 
            t.classList.add('opacity-0', 'scale-95'); // Fade out
            setTimeout(() => t.remove(), 500); 
        }, 3500);
    };

    // Swipe Notification
    let touchStartX = 0;
    const np = document.getElementById('notif-panel');
    np.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive: true});
    np.addEventListener('touchend', e => { if(e.changedTouches[0].screenX > touchStartX + 50) closeNotif(); });

    // Charts
    const renderCharts = (td, tlt, tlr) => {
        const ctxF = document.getElementById('financeChart').getContext('2d');
        if (financeChartInstance) financeChartInstance.destroy();
        financeChartInstance = new Chart(ctxF, { 
            type: 'bar', 
            data: { labels: ['‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ', '‡¶ã‡¶£ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®', '‡¶ã‡¶£ ‡¶´‡ßá‡¶∞‡¶§'], datasets: [{ data: [td, tlt, tlr], backgroundColor: ['#22c55e', '#ef4444', '#eab308'], borderRadius: 6, barThickness: 40 }] }, 
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ‡ß≥ ${getBengaliNumber(c.raw)}` } } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { family: "'Hind Siliguri'" } } }, x: { grid: { display: false }, ticks: { font: { family: "'Hind Siliguri'", weight: '600' } } } } } 
        });

        const mData = {}; members.forEach(m => (m.transactions||[]).forEach(t => { if(t.type==='deposit') { const k = t.date.substring(0,7); mData[k] = (mData[k]||0)+Number(t.amount); } }));
        const labels = Object.keys(mData).sort().map(m => { const d = new Date(m+'-01'); return d.toLocaleString('bn-BD', { month: 'short', year: '2-digit' }); });
        const data = Object.keys(mData).sort().map(k => mData[k]);
        
        const ctxT = document.getElementById('trendChart').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(ctxT, { 
            type: 'line', 
            data: { labels: labels, datasets: [{ label: '‡¶ú‡¶Æ‡¶æ', data: data, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 4, pointBackgroundColor: '#ffffff', pointBorderColor: '#6366f1', pointBorderWidth: 2 }] }, 
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ‡ß≥ ${getBengaliNumber(c.raw)}` } } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9', borderDash: [5, 5] } }, x: { grid: { display: false } } } } 
        });
    };

    // Rendering UI
    const renderHeaderLogo = () => {
        const img = document.getElementById('header-logo-img');
        if (logoUrl) { 
            img.src = logoUrl; img.onerror = () => img.src = 'https://placehold.co/48x48/FFFFFF/6366f1?text=MG'; 
            localStorage.setItem('cached_logo_url', logoUrl); // Cache Logo
        }
    };
    const renderImportantLinks = () => {
        // Hiding important links display as requested, but keeping app button logic working
        const c = document.getElementById('important-links-display'); 
        if(c) { c.innerHTML = ''; c.classList.add('hidden'); }

        // App Button Logic
        const btn = document.getElementById('header-app-btn');
        if (appDownloadUrl) { btn.href = appDownloadUrl; btn.target = "_blank"; }
        else { 
            const appLink = importantLinks.find(l => l.name.toLowerCase().includes('app') || l.name.includes('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™'));
            if(appLink) { btn.href = appLink.url; btn.target = "_blank"; } else { btn.href = "#"; btn.onclick = (e) => { e.preventDefault(); showMessage('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá!', 'info'); }; }
        }
    };

    const renderUI = () => {
        let td = 0, tlt = 0, tlr = 0;
        members.forEach(m => { const t = calculateMemberTotals(m); td+=t.totalDeposit; tlt+=t.totalLoanTaken; tlr+=t.totalLoanRepaid; });
        
        document.getElementById('total-members').textContent = getBengaliNumber(members.length);
        document.getElementById('total-paid').textContent = `‡ß≥ ${getBengaliNumber(td)}`;
        document.getElementById('total-loan-given').textContent = `‡ß≥ ${getBengaliNumber(tlt)}`;
        
        renderCharts(td, tlt, tlr);
        
        memberListCardContainer.innerHTML = ''; memberListPlaceholder.classList.add('hidden');
        const filtered = members.filter(m => {
            const q = searchQuery.toLowerCase().trim();
            return !q || (m.name||'').toLowerCase().includes(q) || (m.id||'').includes(q) || (m.phone||'').includes(q) || (m.cardNumber||'').includes(q);
        });

        if (filtered.length === 0) memberListPlaceholder.classList.remove('hidden');
        else {
            filtered.sort((a,b) => (a.name||'').localeCompare(b.name||'','bn')).forEach(m => {
                const t = calculateMemberTotals(m);
                const ph = `https://placehold.co/64x64/e2e8f0/64748b?text=${encodeURIComponent(m.name?.charAt(0)||'?')}`;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl p-4 shadow-sm border border-slate-200 hover:shadow-md hover:border-indigo-200 transition group flex flex-col h-full relative overflow-hidden';
                card.innerHTML = `
                    <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition text-6xl select-none">üÜî</div>
                    <div class="flex items-center gap-4 mb-4 relative z-10">
                        <img class="w-14 h-14 rounded-full object-cover border-2 border-slate-100 shadow-sm" src="${m.photoUrl||ph}" onerror="this.src='${ph}'">
                        <div class="overflow-hidden">
                            <h4 class="font-bold text-slate-800 truncate text-lg">${m.name}</h4>
                            <p class="text-xs text-slate-500 font-mono">ID: ${m.id}</p>
                            <p class="text-xs text-slate-500 mt-0.5">üìû ${m.phone}</p>
                        </div>
                    </div>
                    <div class="mt-auto space-y-2 relative z-10">
                        <div class="flex justify-between text-sm bg-green-50 px-3 py-2 rounded-lg border border-green-100"><span class="text-green-700 font-medium">‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶æ</span><span class="font-bold text-green-700">‡ß≥ ${getBengaliNumber(t.totalDeposit)}</span></div>
                        <div class="flex justify-between text-sm bg-red-50 px-3 py-2 rounded-lg border border-red-100"><span class="text-red-700 font-medium">‡¶ã‡¶£</span><span class="font-bold text-red-700">‡ß≥ ${getBengaliNumber(t.currentLoan)}</span></div>
                    </div>
                    <button class="view-profile-btn mt-4 w-full bg-indigo-50 text-indigo-600 py-2 rounded-lg text-sm font-bold hover:bg-indigo-600 hover:text-white transition shadow-sm" data-id="${m.id}">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                `;
                memberListCardContainer.appendChild(card);
            });
        }
        if(activeMember) { const fresh = members.find(m=>m.id===activeMember.id); if(fresh && filtered.includes(fresh)) showProfile(fresh.id, false); else closeProfileModal(); }
    };

    const renderNoticeBoard = () => {
        const display = document.getElementById('notice-display'); display.innerHTML = '';
        const ticker = document.getElementById('bottom-ticker');
        const tickerWrapper = document.getElementById('ticker-wrapper');
        
        // UPDATED: Ticker Logic for seamless infinite loop
        if (notice.scrollingText?.trim()) { 
            ticker.classList.remove('hidden'); 
            const text = notice.scrollingText;
            // Add spacing between the two copies
            const separator = '<span class="mx-8 text-indigo-400">‚ùñ</span>';
            const fullText = (text + separator).repeat(Math.max(1, Math.ceil(window.innerWidth / (text.length * 10)))); // Basic repeat if text is short
            
            // Inject two identical items for the infinite scroll effect
            tickerWrapper.innerHTML = `
                <div class="ticker-item text-xs sm:text-sm font-medium text-indigo-100">${fullText}</div>
                <div class="ticker-item text-xs sm:text-sm font-medium text-indigo-100">${fullText}</div>
            `;
        } 
        else ticker.classList.add('hidden');

        if (noticeSlideInterval) clearInterval(noticeSlideInterval);
        const images = (Array.isArray(notice.imageUrls) ? notice.imageUrls : [notice.imageUrl]).filter(u => u);

        if (images.length > 0) {
            const slides = images.map((u,i) => `<div class="absolute inset-0 transition-opacity duration-1000 ${i===0?'opacity-100 z-10':'opacity-0 z-0'} slide-wrapper"><img src="${u}" class="w-full h-full object-cover animate-kenburns"><div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div></div>`).join('');
            display.innerHTML += `<div class="relative w-full h-48 sm:h-64 rounded-xl overflow-hidden mb-4 shadow-sm group">${slides}</div>`;
            if (images.length > 1) {
                let cur = 0;
                const els = () => display.querySelectorAll('.slide-wrapper');
                const next = () => { const s = els(); s[cur].classList.remove('opacity-100','z-10'); s[cur].classList.add('opacity-0'); cur=(cur+1)%images.length; s[cur].classList.remove('opacity-0'); s[cur].classList.add('opacity-100','z-10'); };
                noticeSlideInterval = setInterval(next, 5000);
            }
        }
        if (notice.text) display.innerHTML += `<div class="prose prose-sm prose-slate max-w-none mb-3">${notice.text.split('\n').map(p=>`<p>${p}</p>`).join('')}</div>`;
        if (notice.linkUrl) display.innerHTML += `<a href="${notice.linkUrl}" target="_blank" class="block text-center bg-slate-800 text-white text-sm font-bold py-2 rounded-lg hover:bg-slate-700 transition">üîó ${notice.linkText||'‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'}</a>`;
        if (!images.length && !notice.text) display.innerHTML = `<div class="text-center text-slate-400 py-6 italic">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶®‡ßá‡¶á</div>`;
    };

    // Profile & Modal Logic
    const showProfile = (id, animate = true) => {
        const m = members.find(x => x.id === id); activeMember = m; if(!m) return;
        const t = calculateMemberTotals(m);
        const ph = m.photoUrl || `https://placehold.co/96x96/e2e8f0/64748b?text=${encodeURIComponent(m.name?.charAt(0)||'?')}`;
        
        document.getElementById('profile-header-img').src = ph;
        document.getElementById('profile-header-name').textContent = m.name || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á';
        document.getElementById('profile-id').textContent = `ID: ${m.id}`;
        
        ['name','email','phone','employee-id','card-number','notes'].forEach(k => {
             const v = m[k.replace('-','')] || m[k] || 'N/A';
             document.getElementById(`profile-${k}-view`).textContent = v;
        });
        
        document.getElementById('paid-total').textContent = `‡ß≥ ${getBengaliNumber(t.totalDeposit)}`;
        document.getElementById('current-loan').textContent = `‡ß≥ ${getBengaliNumber(t.currentLoan)}`;
        document.getElementById('loan-taken').textContent = `‡ß≥ ${getBengaliNumber(t.totalLoanTaken)}`;
        document.getElementById('loan-repaid').textContent = `‡ß≥ ${getBengaliNumber(t.totalLoanRepaid)}`;

        const tbody = document.getElementById('transactions-table-body');
        tbody.innerHTML = (m.transactions||[]).length === 0 ? '<tr><td colspan="3" class="py-6 text-center text-slate-400 italic">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á</td></tr>' : 
        [...m.transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(x => {
            const clr = x.type==='deposit'?'text-green-600':x.type==='loanTaken'?'text-blue-600':'text-yellow-600';
            const lbl = x.type==='deposit'?'‡¶ï‡¶ø‡¶∏‡ßç‡¶§‡¶ø/‡¶ú‡¶Æ‡¶æ':x.type==='loanTaken'?'‡¶ã‡¶£ ‡¶ó‡ßç‡¶∞‡¶π‡¶£':'‡¶ã‡¶£ ‡¶´‡ßá‡¶∞‡¶§';
            return `<tr class="hover:bg-slate-50"><td class="py-3 px-4 text-slate-600">${formatDate(x.date)}</td><td class="py-3 px-4"><span class="font-medium text-slate-700">${lbl}</span>${x.description?`<br><span class="text-xs text-slate-400">${x.description}</span>`:''}</td><td class="py-3 px-4 text-right font-mono font-bold ${clr}">${getBengaliNumber(x.amount)}</td></tr>`;
        }).join('');

        document.querySelectorAll('.profile-tab').forEach(x => { x.classList.remove('tab-active','text-indigo-600'); x.classList.add('text-slate-500'); });
        document.getElementById('profile-tab-details').classList.add('tab-active','text-indigo-600'); document.getElementById('profile-tab-details').classList.remove('text-slate-500');
        
        document.getElementById('profile-content-details').classList.remove('hidden');
        document.getElementById('profile-content-transactions').classList.add('hidden');
        document.getElementById('profile-content-summary').classList.add('hidden');

        if(animate) { 
            profileModal.classList.remove('hidden'); profileModal.classList.add('flex');
            document.getElementById('profile-modal-box').classList.remove('modal-exit');
        }
    };
    const closeProfileModal = () => {
        const box = document.getElementById('profile-modal-box');
        box.classList.add('modal-exit');
        setTimeout(() => { profileModal.classList.add('hidden'); profileModal.classList.remove('flex'); box.classList.remove('modal-exit'); activeMember = null; }, 200);
    };

    // Fund Modal
    const renderFundModal = () => {
        const c = document.getElementById('fund-list-container');
        const mDeps = members.reduce((acc,m) => { (m.transactions||[]).filter(t=>t.type==='deposit'&&t.date).forEach(t=>{ const k=t.date.substring(0,7); acc[k]=(acc[k]||0)+Number(t.amount); }); return acc; }, {});
        const sorted = Object.keys(mDeps).sort().reverse();
        
        c.innerHTML = sorted.length ? sorted.map(k => {
            const dist = fundDistribution[k];
            const r = dist ? members.find(m=>m.id===dist.receiverId) : null;
            return `<div class="p-4 border border-slate-200 rounded-xl bg-white shadow-sm"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-slate-700">${formatDate(k+'-01','monthYear')}</h4><span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">‡¶Æ‡ßã‡¶ü: ‡ß≥ ${getBengaliNumber(mDeps[k])}</span></div>${r ? `<div class="flex items-center gap-3 bg-indigo-50 p-3 rounded-lg mt-2"><img src="${r.photoUrl||'https://placehold.co/40'}" class="w-10 h-10 rounded-full bg-white"><div><p class="text-xs text-indigo-500 font-bold uppercase">‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï</p><p class="text-sm font-bold text-slate-800">${r.name}</p><p class="text-xs text-slate-500">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ‡ß≥ ${getBengaliNumber(dist.amount)}</p></div></div>` : `<p class="text-xs text-slate-400 italic mt-2">‡¶è‡¶ñ‡¶®‡¶ì ‡¶¨‡¶ø‡¶§‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>`}</div>`;
        }).join('') : '<div class="text-center py-8 text-slate-400">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</div>';
    };

    // Lottery Render
    const renderLotteryModal = () => {
        const lp = lottery.participants||[], lh = lottery.history||[];
        document.getElementById("lotteryCountBadge").textContent = getBengaliNumber(lp.length);
        const list = document.getElementById("lotteryParticipants");
        list.innerHTML = lp.length ? lp.map((n,i)=>`<li class="bg-slate-800/50 border border-slate-700 rounded-lg p-2 text-center text-slate-300 text-sm font-medium relative overflow-hidden group hover:bg-cyan-900/20 hover:border-cyan-500/50 transition"><span class="absolute top-1 left-1 text-[10px] text-slate-600">#${i+1}</span>${n}</li>`).join('') : `<li class="col-span-full text-center text-slate-500 py-8">‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡ßá‡¶á</li>`;
        
        const hist = document.getElementById("lotteryHistory");
        hist.innerHTML = lh.length ? [...lh].reverse().map(h=>`<li class="flex justify-between items-center bg-slate-800/40 p-2 rounded border-l-2 border-cyan-500 mb-2"><span class="text-cyan-200 font-medium text-xs">${h.winner}</span><span class="text-slate-500 text-[10px]">${h.date}</span></li>`).join('') : `<li class="text-center text-slate-600 text-xs py-2">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</li>`;

        const winSec = document.getElementById("lotteryWinnerSection");
        const latest = lh[lh.length-1];
        if(latest) {
            document.getElementById("lotteryWinnerText").textContent = latest.winner;
            document.getElementById("lotteryWinnerDate").textContent = latest.date;
            winSec.classList.remove('hidden', 'scale-95', 'opacity-0');
        } else {
            winSec.classList.add('hidden', 'scale-95', 'opacity-0');
        }
    };
    
    // Confetti
    const canvas = document.getElementById("confetti"), ctx = canvas.getContext("2d");
    let parts = [];
    const resizeCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.addEventListener('resize', resizeCanvas);
    const updateConfetti = () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        let act = false;
        parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.vx*=0.95; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,6,6); if(p.y<canvas.height) act=true; });
        if(act) requestAnimationFrame(updateConfetti);
    };
    const startConfetti = () => {
        parts=[]; for(let i=0;i<100;i++) parts.push({x:canvas.width/2, y:canvas.height/2, vx:(Math.random()-.5)*20, vy:(Math.random()-.5)*20, c:`hsl(${Math.random()*360},70%,50%)`});
        updateConfetti();
    };

    // Firebase Start
    const initFirebase = () => {
        // Initialize Cached Logo for Loader
        const cachedLogo = localStorage.getItem('cached_logo_url');
        if(cachedLogo) {
            const loaderImg = document.getElementById('loader-logo-img');
            if(loaderImg) loaderImg.src = cachedLogo;
        }

        try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } catch(e) { console.error(e); }
        onAuthStateChanged(auth, async (u) => {
            if(u) {
                mainAppContent.classList.remove('hidden'); document.getElementById('app-loader').classList.add('opacity-0'); setTimeout(()=>document.getElementById('app-loader').remove(),500);
                const docRef = doc(db, 'artifacts', appId, 'public-data', 'main');
                onSnapshot(docRef, (s) => {
                    const d = s.data(); if(!d) return;
                    members = d.members||[]; fundDistribution = d.fundDistribution||{};
                    notice = typeof d.notice==='string' ? {text:d.notice} : (d.notice||{});
                    logoUrl = d.logoUrl||''; importantLinks = d.importantLinks||[]; appDownloadUrl = d.appDownloadUrl||'';
                    activityLog = d.activityLog||[];
                    lottery = { participants: d.lottery?.participants||[], history: d.lottery?.history||[], liveDraw: d.lottery?.liveDraw };
                    
                    if(d.lottery?.liveDraw?.ts > lastDrawTime && !isFirstSnapshot) {
                         lastDrawTime = d.lottery.liveDraw.ts;
                         document.getElementById('lottery-modal').classList.remove('hidden'); renderLotteryModal(); startConfetti();
                    }
                    isFirstSnapshot = false;
                    renderUI(); renderHeaderLogo(); renderImportantLinks(); renderNoticeBoard(); renderNotifications();
                    if(!initialLoadComplete) { checkAndPlayNotifications(); initialLoadComplete=true; }
                });
            } else { try { await signInAnonymously(auth); } catch(e){console.error(e);} }
        });
    };
    initFirebase();

    // Event Delegation
    document.addEventListener('click', e => {
        const t = e.target.closest('button, a, .view-profile-btn, [data-notification-msg]');
        if(!t) return;
        
        // Notification Click
        if(t.hasAttribute('data-notification-msg')) {
            const mid = t.getAttribute('data-member-id');
            const msg = t.getAttribute('data-notification-msg');
            closeNotif();
            if(mid) showProfile(mid);
            else if(msg.includes('‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø')) { document.getElementById('lottery-modal').classList.remove('hidden'); renderLotteryModal(); resizeCanvas(); if(lottery.history.length) startConfetti(); }
            else if(msg.includes('‡¶§‡¶π‡¶¨‡¶ø‡¶≤')) { renderFundModal(); document.getElementById('monthly-fund-modal').classList.remove('hidden'); document.getElementById('monthly-fund-modal').classList.add('flex'); }
            return;
        }

        // Actions
        const id = t.id;
        if(id === 'open-notif-btn') openNotif();
        else if(id === 'close-notif-btn' || id === 'notif-overlay-bg') closeNotif();
        else if(id === 'mark-read-btn') { localStorage.setItem('samiti_notif_last_read', activityLog.length?activityLog[0].ts:0); renderNotifications(); showMessage('‡¶™‡¶†‡¶ø‡¶§ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); }
        else if(t.classList.contains('view-profile-btn')) showProfile(t.dataset.id);
        else if(id === 'close-profile') closeProfileModal();
        else if(t.classList.contains('profile-tab')) {
            document.querySelectorAll('.profile-tab').forEach(x => { x.classList.remove('tab-active','text-indigo-600'); x.classList.add('text-slate-500'); });
            t.classList.add('tab-active','text-indigo-600'); t.classList.remove('text-slate-500');
            ['details','transactions','summary'].forEach(k => document.getElementById(`profile-content-${k}`).classList.add('hidden'));
            document.getElementById(`profile-content-${id.replace('profile-tab-','')}`).classList.remove('hidden');
        }
        else if(id === 'view-monthly-fund-btn') { renderFundModal(); document.getElementById('monthly-fund-modal').classList.remove('hidden'); document.getElementById('monthly-fund-modal').classList.add('flex'); }
        else if(id === 'close-fund-modal') { document.getElementById('monthly-fund-modal').classList.add('hidden'); document.getElementById('monthly-fund-modal').classList.remove('flex'); }
        else if(id === 'view-lottery-btn') { document.getElementById('lottery-modal').classList.remove('hidden'); renderLotteryModal(); resizeCanvas(); if(lottery.history.length) startConfetti(); }
        else if(id === 'close-lottery-btn') document.getElementById('lottery-modal').classList.add('hidden');
    });

    document.getElementById('search-member-input').addEventListener('input', e => { searchQuery = e.target.value; renderUI(); });
  </script>
</body>
</html>